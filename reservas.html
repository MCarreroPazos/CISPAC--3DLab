<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Reservas - CISPAC 3D LAB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <style>
    body { padding-top: 40px; }
    #calendar, #resumen, #historial, #selectorEquipo {
      max-width: 900px;
      margin: 30px auto;
      display: none;
    }
    #loginForm {
      max-width: 400px;
      margin: auto;
    }
  </style>
</head>
<body>
  <div class="container text-center">
    <h1>CISPAC 3D LAB - Reservas</h1>

    <div id="loginForm">
      <h3>Iniciar sesión</h3>
      <input class="form-control" type="text" id="username" placeholder="Usuario" /><br />
      <input class="form-control" type="password" id="password" placeholder="Contraseña" /><br />
      <button class="btn btn-primary" onclick="login()">Entrar</button>
    </div>

    <div id="mainInterface" style="display:none;">
      <hr />
      <div class="text-center">
        <button class="btn btn-primary" onclick="mostrarReserva()">Reservar equipo</button>
        <button class="btn btn-success" onclick="devolverEquipo()">Devolver equipo</button>
        <button class="btn btn-info" onclick="verHistorial()">Ver historial completo</button>
      </div>

      <div id="selectorEquipo">
        <label for="equipos"><b>Selecciona un equipo:</b></label>
        <select id="equipos" class="form-control" style="max-width:300px; margin: 0 auto;" onchange="cambiarEquipo()">
          <option value="">-- Selecciona --</option>
        </select>
      </div>

      <div id="calendar"></div>

      <div id="resumen">
        <h3>Reservas activas</h3>
        <table class="table table-striped">
          <thead>
            <tr><th>Nombre</th><th>Inicio</th><th>Fin</th></tr>
          </thead>
          <tbody id="tablaReservas"></tbody>
        </table>
      </div>

      <div id="historial">
        <h3>Historial de reservas</h3>
        <table class="table table-bordered">
          <thead>
            <tr><th>Usuario</th><th>Equipo</th><th>Fecha</th><th>Nombre</th><th>Devuelto por</th><th>Fecha devolución</th></tr>
          </thead>
          <tbody id="tablaHistorial"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tabletop@1.6.1/tabletop.min.js"></script>

  <script>
    const usuariosAutorizados = {
      "usuario1": "clave123",
      "usuario2": "cispac2025"
    };

    const equipos = [
      "Escáner 3D de largo alcance",
      "Escáner 3D de corto alcance",
      "Georradar",
      "Dron LiDAR",
      "Impresora 3D",
      "Workstation de procesamiento"
    ];

    let reservasPorEquipo = {};
    equipos.forEach(e => reservasPorEquipo[e] = []);

    let calendario = null;
    let equipoSeleccionado = "";
    let usuarioLogueado = "";

    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzg68zK1UjGKkKArvc08wAqisJYcAtu-q0ztDzzsHFJ2023Z6L6jPZ_Uz9-pd6e0EQJ/exec";
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQg5tj3JP95AGDZhCfVbtqkSwrtV9kj5e6B6vldCDZM_QYEgLMmLHVCmoPo-DFDKS1n3vYT3Go0GAA2/pubhtml";

    function login() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      if (usuariosAutorizados[user] === pass) {
        usuarioLogueado = user;
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("mainInterface").style.display = "block";
      } else {
        alert("Usuario o contraseña incorrectos.");
      }
    }

    function mostrarReserva() {
      document.getElementById("historial").style.display = "none";
      document.getElementById("selectorEquipo").style.display = "block";
      document.getElementById("calendar").style.display = "block";
      document.getElementById("resumen").style.display = "block";
      llenarDesplegable();

      // Esperar a que el calendario esté visible para crearlo y renderizarlo
      setTimeout(() => {
        if (calendario) calendario.destroy();

        calendario = new FullCalendar.Calendar(document.getElementById("calendar"), {
          initialView: "dayGridMonth",
          selectable: true,
          locale: "es",
          select: function(info) {
            const nombre = prompt("Introduce el nombre de quien reserva:");
            if (nombre) {
              const event = {
                title: nombre,
                start: info.startStr,
                end: info.endStr,
                allDay: true
              };
              reservasPorEquipo[equipoSeleccionado].push(event);
              calendario.addEvent(event);
              llenarDesplegable();
              actualizarTablaReservas();

              fetch(WEBHOOK_URL, {
                method: "POST",
                body: JSON.stringify({
                  tipo: "reserva",
                  usuario: usuarioLogueado,
                  equipo: equipoSeleccionado,
                  fecha: info.startStr,
                  nombre: nombre
                }),
                headers: { "Content-Type": "application/json" }
              });
            }
          },
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay"
          },
          events: reservasPorEquipo[equipoSeleccionado] || []
        });

        calendario.render();
      }, 50);
    }

    function llenarDesplegable() {
      const select = document.getElementById("equipos");
      select.innerHTML = '<option value="">-- Selecciona --</option>';
      const hoy = new Date().toISOString().split("T")[0];
      equipos.forEach(eq => {
        // Check if eq has a reservation active today
        const reservadoHoy = reservasPorEquipo[eq].some(ev => ev.start <= hoy && (!ev.end || ev.end >= hoy));
        if (!reservadoHoy) {
          const option = document.createElement("option");
          option.value = eq;
          option.text = eq;
          select.appendChild(option);
        }
      });
    }

    function actualizarTablaReservas() {
      const tabla = document.getElementById("tablaReservas");
      tabla.innerHTML = "";
      if (!equipoSeleccionado) return;
      reservasPorEquipo[equipoSeleccionado].forEach(ev => {
        const fila = document.createElement("tr");
        fila.innerHTML = `<td>${ev.title}</td><td>${ev.start}</td><td>${ev.end || "-"}</td>`;
        tabla.appendChild(fila);
      });
    }

    function cambiarEquipo() {
      const nuevoEquipo = document.getElementById("equipos").value;
      if (!nuevoEquipo) return alert("Por favor, selecciona un equipo.");
      equipoSeleccionado = nuevoEquipo;

      if (calendario) calendario.destroy();

      calendario = new FullCalendar.Calendar(document.getElementById("calendar"), {
        initialView: "dayGridMonth",
        selectable: true,
        locale: "es",
        select: function(info) {
          const nombre = prompt("Introduce el nombre de quien reserva:");
          if (nombre) {
            const event = {
              title: nombre,
              start: info.startStr,
              end: info.endStr,
              allDay: true
            };
            reservasPorEquipo[equipoSeleccionado].push(event);
            calendario.addEvent(event);
            llenarDesplegable();
            actualizarTablaReservas();

            fetch(WEBHOOK_URL, {
              method: "POST",
              body: JSON.stringify({
                tipo: "reserva",
                usuario: usuarioLogueado,
                equipo: equipoSeleccionado,
                fecha: info.startStr,
                nombre: nombre
              }),
              headers: { "Content-Type": "application/json" }
            });
          }
        },
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay"
        },
        events: reservasPorEquipo[equipoSeleccionado]
      });

      calendario.render();
      actualizarTablaReservas();
    }

    function devolverEquipo() {
      const hoy = new Date().toISOString().split("T")[0];
      const equiposPrestados = equipos.filter(eq =>
        reservasPorEquipo[eq].some(ev => ev.start <= hoy && (!ev.end || ev.end >= hoy))
      );

      if (equiposPrestados.length === 0) {
        return alert("No hay equipos en préstamo actualmente.");
      }

      let equipoADevolver = prompt("Equipos en préstamo:\n" +
        equiposPrestados.map((e, i) => (i + 1) + ". " + e).join("\n") +
        "\n\nEscribe el número del equipo que quieres devolver:");
      if (!equipoADevolver) return;
      equipoADevolver = equipoADevolver.trim();
      const indice = parseInt(equipoADevolver, 10);
      if (isNaN(indice) || indice < 1 || indice > equiposPrestados.length) {
        return alert("Selección inválida.");
      }
      equipoSeleccionado = equiposPrestados[indice - 1];

      const nombre = prompt("Introduce el nombre de quien devuelve el equipo:");
      if (!nombre) return;

      const reservas = reservasPorEquipo[equipoSeleccionado];
      const ultima = reservas.slice().reverse().find(ev => ev.title === nombre && ev.start <= hoy && (!ev.end || ev.end >= hoy));
      if (!ultima) return alert("Reserva no encontrada para ese equipo y nombre.");

      reservasPorEquipo[equipoSeleccionado] = reservas.filter(ev => ev !== ultima);

      if (calendario) {
        const evento = calendario.getEvents().find(ev => ev.title === nombre && ev.startStr === ultima.start);
        if (evento) evento.remove();
      }

      actualizarTablaReservas();
      llenarDesplegable();

      fetch(WEBHOOK_URL, {
        method: "POST",
        body: JSON.stringify({
          tipo: "devolucion",
          usuario: usuarioLogueado,
          equipo: equipoSeleccionado,
          fecha: ultima.start,
          nombre: nombre,
          devueltoPor: nombre,
          fechaDevolucion: hoy
        }),
        headers: { "Content-Type": "application/json" }
      }).then(() => alert("Devolución registrada correctamente."));
    }

    function verHistorial() {
      document.getElementById("historial").style.display = "block";
      document.getElementById("calendar").style.display = "none";
      document.getElementById("selectorEquipo").style.display = "none";
      document.getElementById("resumen").style.display = "none";

      Tabletop.init({
        key: SHEET_URL,
        simpleSheet: true,
        callback: function(data) {
          const tabla = document.getElementById("tablaHistorial");
          tabla.innerHTML = "";
          data.forEach(row => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
              <td>${row.Usuario}</td><td>${row.Equipo}</td><td>${row.Fecha}</td>
              <td>${row.Nombre_de_reserva}</td><td>${row.Devuelto_por}</td><td>${row.Fecha_devolucion}</td>
            `;
            tabla.appendChild(fila);
          });
        }
      });
    }
  </script>
</body>
</html>
