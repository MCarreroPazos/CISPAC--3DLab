<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Reservas - CISPAC 3D LAB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/index.global.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    body {
      padding-top: 40px;
    }
    #calendar {
      max-width: 900px;
      margin: 20px auto;
    }
    #loginForm {
      max-width: 400px;
      margin: auto;
    }
  </style>
</head>
<body>

<div class="container text-center">
  <h1>CISPAC 3D LAB - Reservas</h1>

  <div id="loginForm">
    <h3>Iniciar sesión</h3>
    <input class="form-control" type="text" id="username" placeholder="Usuario"><br>
    <input class="form-control" type="password" id="password" placeholder="Contraseña"><br>
    <button class="btn btn-primary" onclick="login()">Entrar</button>
  </div>

  <div id="mainInterface" style="display:none;">
    <hr>
    <label for="equipos"><b>Selecciona un equipo:</b></label>
    <select id="equipos" class="form-control" style="max-width:300px; margin: 0 auto;" onchange="cambiarEquipo()">
      <option value="">-- Selecciona --</option>
    </select>

    <div id="calendar"></div>

    <div class="text-center" style="margin-top: 10px;">
      <button class="btn btn-success" onclick="devolverEquipo()">Devolver equipo</button>
    </div>
  </div>
</div>

<!-- FullCalendar Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/index.global.min.js"></script>

<script>
  const usuariosAutorizados = {
    "usuario1": "clave123",
    "usuario2": "cispac2025"
  };

  const equipos = [
    "Escáner 3D de largo alcance",
    "Escáner 3D de corto alcance",
    "Georradar",
    "Dron LiDAR",
    "Impresora 3D",
    "Workstation de procesamiento"
  ];

  let reservasPorEquipo = {};
  equipos.forEach(e => reservasPorEquipo[e] = []);

  let calendario = null;
  let equipoSeleccionado = "";
  let usuarioLogueado = "";

  const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzg68zK1UjGKkKArvc08wAqisJYcAtu-q0ztDzzsHFJ2023Z6L6jPZ_Uz9-pd6e0EQJ/exec";

  function login() {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;

    if (usuariosAutorizados[user] === pass) {
      usuarioLogueado = user;
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("mainInterface").style.display = "block";
      llenarDesplegable();
    } else {
      alert("Usuario o contraseña incorrectos.");
    }
  }

  function llenarDesplegable() {
    const select = document.getElementById("equipos");
    select.innerHTML = '<option value="">-- Selecciona --</option>';
    const hoy = new Date().toISOString().split("T")[0];

    equipos.forEach(eq => {
      const reservadoHoy = reservasPorEquipo[eq].some(ev => ev.start <= hoy && (!ev.end || ev.end >= hoy));
      if (!reservadoHoy) {
        const option = document.createElement("option");
        option.value = eq;
        option.text = eq;
        select.appendChild(option);
      }
    });
  }

  function cambiarEquipo() {
    const nuevoEquipo = document.getElementById("equipos").value;
    if (!nuevoEquipo) return;

    equipoSeleccionado = nuevoEquipo;

    if (calendario) calendario.destroy();

    const calendarEl = document.getElementById("calendar");
    calendario = new FullCalendar.Calendar(calendarEl, {
      plugins: [FullCalendarDayGrid, FullCalendarInteraction],
      initialView: "dayGridMonth",
      locale: "es",
      selectable: true,
      selectMirror: true,
      select: function(info) {
        const nombre = prompt("Introduce el nombre de quien reserva:");
        if (nombre) {
          const event = {
            title: nombre,
            start: info.startStr,
            end: info.endStr,
            allDay: true
          };
          reservasPorEquipo[equipoSeleccionado].push(event);
          calendario.addEvent(event);
          llenarDesplegable();

          fetch(WEBHOOK_URL, {
            method: "POST",
            body: JSON.stringify({
              tipo: "reserva",
              usuario: usuarioLogueado,
              equipo: equipoSeleccionado,
              fecha: info.startStr,
              nombre: nombre
            }),
            headers: {
              "Content-Type": "application/json"
            }
          });
        }
      },
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },
      events: reservasPorEquipo[equipoSeleccionado]
    });

    calendario.render();
  }

  function devolverEquipo() {
    if (!equipoSeleccionado) {
      alert("Primero selecciona un equipo.");
      return;
    }

    const nombreReserva = prompt("Introduce el nombre de quien devuelve el equipo:");
    if (!nombreReserva) return;

    const fechaDevolucion = new Date().toISOString().split("T")[0];

    const reservas = reservasPorEquipo[equipoSeleccionado];
    const ultima = reservas.slice().reverse().find(ev => ev.title === nombreReserva);

    if (!ultima) {
      alert("No se encontró ninguna reserva activa con ese nombre.");
      return;
    }

    fetch(WEBHOOK_URL, {
      method: "POST",
      body: JSON.stringify({
        tipo: "devolucion",
        usuario: usuarioLogueado,
        equipo: equipoSeleccionado,
        fecha: ultima.start,
        nombre: nombreReserva,
        devueltoPor: nombreReserva,
        fechaDevolucion: fechaDevolucion
      }),
      headers: {
        "Content-Type": "application/json"
      }
    }).then(() => {
      alert("Devolución registrada correctamente.");
    });
  }
</script>
</body>
</html>
